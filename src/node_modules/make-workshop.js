const url = new URL('script.txt', location.href).href
const get = async () => (s || (s = await fetch(url).then(x => x.text())))
let s

module.exports = make_workshop

async function make_workshop (data, iframe) {
  // @TODO: generate for IFRAME
  // @TODO: vs. generate for IPFS
  const source = `;(() => { ${await get()} })();
  setTimeout(async () => {
    var app = await workshop(${iframe ? JSON.stringify(data) : ''})
    const el = await app.render()
    document.body.appendChild(el)
  }, 0)
  var st = document.createElement('style')
  st.innerHTML = \`
    html {
      box-sizing: border-box;
      display: table;
      min-width: 100%;
      margin: 0;
    }
    body {
      box-sizing: border-box;
      margin: 0;
      display: flex;
      flex-flow: column;
      height: 100vh;
    }\`
  document.head.appendChild(st)`
  // var sss1 = source.indexOf(', location.href)')
  // console.log('sss1', sss1)
  if (iframe) {
    var source2 = source.replace(', location.href)', ', location.href.startsWith("blob:") ? location.href.split("blob:")[1] : location.href)')
  }
  // var sss2 = source2.indexOf(', location.href)')
  // console.log('sss2', sss2)
  return `<!doctype html><html>
    <head><meta charset="utf-8"></head>
    <body><script>${iframe ? source2 : source}</script></body>
  </html>`
}
